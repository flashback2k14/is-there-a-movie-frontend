<dom-module id="botomo-app">
  <template>
    <style>
      .app {
        @apply(--layout-vertical);
      }
      .app--centering {
        @apply(--layout-center);
      }

      .app__title {
        margin-top: 30px;
        @apply(--paper-font-display2);
      }
      .app__content {
        width: 100%;
        margin-top: 30px;
        padding: 20px;
      }
      .app__info {
        --paper-toast-background-color: var(--paper-red-a400);
        --paper-toast-color: #000;
      }
    </style>

    <div class="app">

      <!-- data ares -->
      <botomo-data 
        id="bdRequester"
        on-request-response="_handleRequestResponse"
        on-request-error="_handleRequestError"
        on-request-failed="_handleRequestFailed">
      </botomo-data>

      <!-- title area -->
      <div class="app app--centering app__title">
        <h1>is there a movie?</h1>
      </div>

      <!-- search area -->
      <div class="app app--centering app__content">
        <botomo-search
          webservice-url="[[webserviceUrl]]"
          on-search-response="_handleSearchResponse"
          on-search-error="_handleSearchError"
          on-search-failed="_handleSearchFailed">
        </botomo-search>
      </div>

      <!-- list area -->
      <div class="app app--centering app__content">
        <botomo-list
          id="bList"
          data="{{data}}">
        </botomo-list>
      </div>

      <!-- toast area -->
      <paper-toast id="infoToast" class="app__info"></paper-toast>

    </div>

  </template>

  <script>
    Polymer({
      is: "botomo-app",

      /**
       * 
       */
      properties: {
        webserviceUrl: {
          type: String,
          value: ""
        }
      },

      /**
       * 
       */
      _showMessage: function(msg) {
        this.$.infoToast.text = msg;
        this.$.infoToast.show();
      },

      /**
       * 
       */
      _getAll: function() {
        var options = {
          url: this.webserviceUrl + "api/v1/books"
        };
        this.$.bdRequester.request(options);
      },

      /**
       * BEGIN SEARCH
       */
      /**
       * 
       */
      _handleSearchResponse: function(e) {
        // clear list
        this.set("data", []);
        // get data
        var book = e.detail.detail.response[0];
        if (book) {
          this.push("data", e.detail.detail.response[0]);
        } else {
          this._showMessage("No Books available!");
        }
      },
      /**
       * 
       */
      _handleSearchError: function(e) {
        if (e instanceof Event) {
          this._showMessage(e.detail.detail.error.message);
        }
        /**
         * ToDo:
         *  handle Error from Backend
         */
      },
      /**
       * 
       */
      _handleSearchFailed: function(e) {
        this._showMessage(e.detail.msg);
        this._getAll();
      },
      /**
       * END SEARCH
       */

      /**
       * BEGIN APP
       */
      /**
       * 
       */
      _handleRequestResponse: function(e) {
        var tmp = e.detail.detail.response;
        tmp.forEach(function(item) {
          this.push("data", item);
        }.bind(this));
      },
      /**
       * 
       */
      _handleRequestError: function(e) {
        if (e instanceof Event) {
          this._showMessage(e.detail.detail.error.message ? e.detail.detail.error.message : "Error to load Data!");
          this.$.bList.setTestData();  
        }
        /**
         * ToDo:
         *  handle Error from Backend
         */
      },
      /**
       * 
       */
      _handleRequestFailed: function(e) {
        this._showMessage(e.detail.msg);
      },
      /**
       * END APP
       */

      /**
       * 
       */
      ready: function() {
        // data binding variable for list
        this.data = [];
        // call all books on load
        this._getAll();
      }
    });
  </script>
</dom-module>
